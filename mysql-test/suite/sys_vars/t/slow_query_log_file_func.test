########### mysql-test\t\slow_query_log_file_func.test #########################
#                                                                              #
# Variable Name: slow_query_log_file                                           #
# Scope: GLOBAL                                                                #
# Access Type: Dynamic                                                         #
# Data Type: Boolean                                                           #
# Default Value: OFF                                                           #
# Valid Values: ON, OFF                                                        #
#                                                                              #
#                                                                              #
# Creation Date: 2008-03-17                                                    #
# Author:  Salman Rawala                                                       #
#                                                                              #
# Description: Test Cases of Dynamic System Variable "slow_query_log_file"     #
#              that checks functionality of this variable                      #
#                                                                              #
# Reference: http://dev.mysql.com/doc/refman/5.1/en/                           #
#    server-system-variables.html#option_mysqld_slow_query_log_file            #
#                                                                              #
################################################################################

# Leaving a note to Oracle for updating the header of this file.
#   I (JFG) do not know what it should be,
#   but the reference to 5.1 doc should probably be removed.

--echo '#--------------------FN_DYNVARS_018_01-------------------------#'
####################################################################
#    Verifying log file after setting it in opt file               #
####################################################################

let $MYSQLD_DATADIR= `select @@datadir`;
--echo ## Checking if my_slow_test.log exists in servers datadir ##
--replace_result $MYSQLD_DATADIR MYSQLD_DATADIR
--file_exists $MYSQLD_DATADIR/my_slow_test.log

--echo ## This case should pass because we have set this filename in opt file ##

--echo
--echo ## Save state.
SET @global_log_slow_extra = @@global.log_slow_extra;
SET @global_log_slow_extra_db = @@global.log_slow_extra_db;

--echo
--echo ## Common to all tests below.
SET @@session.long_query_time=0.1;

# These common regex patterns are for masking-out non-deterministic output.
--let $PATTERN_VER= /.*Version.*started with.*\n//
--let $PATTERN_TCP= /^Tcp port:.*Unix socket:.*\n//
--let $PATTERN_TIME1= /^Time.*Id.*Command.*Argument.*\n//
--let $PATTERN_TIME2= /^# Time: .*/# Time: x/

--let $PATTERN_COMMON= $PATTERN_VER $PATTERN_TCP $PATTERN_TIME1 $PATTERN_TIME2

--let $PATTERN_QT= /^# Query_time: .*Lock_time: .*Rows_sent:/# Query_time: n Lock_time: n Rows_sent:/
--let $PATTERN_TS= /SET timestamp=.*\n//

--echo
--echo ###################################
--echo ## Testing log_slow_extra behavior.

# These regex patterns are for masking-out non-deterministic output.
--let $PATTERN_UH= /^# User@Host:.*Id:.*Db:/# User@Host: n Id: n Db:/
--let $PATTERN_THREAD= /Thread_id:.*Errno:/Thread_id: n Errno:/
--let $PATTERN_BR= /Bytes_received:.*Bytes_sent:.*Read_first:/Bytes_received: n Bytes_sent: n Read_first:/
--let $PATTERN_START= /Start:.*End:.*/Start: n End: n/

--let $PATTERN= $PATTERN_COMMON $PATTERN_UH $PATTERN_QT $PATTERN_THREAD $PATTERN_BR $PATTERN_START $PATTERN_TS

# Doing tests with log_slow_extra_db = 1 allows not having to manage "use ..." in the output.
--echo
--echo ## Testing log_slow_extra behavior is done with log_slow_extra_db = 1.
SET @@global.log_slow_extra_db = 1;

--source include/slow_query_log_file_reset.inc

--echo
--echo ## Testing log_slow_extra = 0.
SET @@global.log_slow_extra = 0;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

--source include/slow_query_log_file_reset.inc

--echo
--echo ## Testing log_slow_extra = 1.
SET @@global.log_slow_extra = 1;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

--echo
--echo ######################################
--echo ## Testing log_slow_extra_db behavior.

# These regex patterns are for masking-out non-deterministic output.
# Replacing User@Host by UH as a trick to conserve "Db: ..." when it is there.
--let $PATTERN_UH1= /^# User@Host:.*Id:.*Db:/# UH: n Id: n Db:/
--let $PATTERN_UH2= /^# User@Host:.*Id:.*/# UH: n Id: n/

--let $PATTERN= $PATTERN_COMMON $PATTERN_UH1 $PATTERN_UH2 $PATTERN_QT $PATTERN_TS

--echo
--echo ## Testing log_slow_extra_db behavior is done with log_slow_extra = 0.
SET @@global.log_slow_extra = 0;

--source include/slow_query_log_file_reset.inc

# We test log_slow_extra_db = 1 before 0 as we want to make sure a "use ..." appears with 0.

--echo 
--echo ## Testing log_slow_extra_db = 1.
SET @@global.log_slow_extra_db = 1;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

--source include/slow_query_log_file_reset.inc

# As we tested with 1 before, we expect a "use ..." to appear with 0.

--echo
--echo ## Testing log_slow_extra_db = 0.
SET @@global.log_slow_extra_db = 0;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

# Cleanup.
--remove_file $MYSQLD_DATADIR/my_slow_test.log

--echo
--echo ## Restore state.
SET @@global.log_slow_extra = @global_log_slow_extra;
SET @@global.log_slow_extra_db = @global_log_slow_extra_db;

# EOF.
