
let $MYSQLD_DATADIR= `select @@datadir`;

--echo ## Save state.
SET @global_log_output = @@global.log_output;
SET @global_slow_query_log = @@global.slow_query_log;
SET @global_slow_query_log_file = @@global.slow_query_log_file;
SET @global_log_slow_extra = @@global.log_slow_extra;
SET @global_log_slow_extra_db = @@global.log_slow_extra_db;

--echo
--echo ## Common to all tests below.

# Setting slow_query_log_file before enabling the slow log to avoid creating a random file.
SET @@global.slow_query_log_file = 'my_slow_test.log';

SET @@global.log_output = 'FILE';
SET @@global.slow_query_log = ON;

# This needs to go after log_output as it might warn otherwise.
#...

SET @@session.long_query_time=0.1;

# These common regex patterns are for masking-out non-deterministic output.
--let $PATTERN_VER= /.*Version.*started with.*\n//
--let $PATTERN_TCP= /^Tcp port:.*Unix socket:.*\n//
--let $PATTERN_TIME1= /^Time.*Id.*Command.*Argument.*\n//
--let $PATTERN_TIME2= /^# Time: .*/# Time: x/

--let $PATTERN_COMMON= $PATTERN_VER $PATTERN_TCP $PATTERN_TIME1 $PATTERN_TIME2

--let $PATTERN_QT= /^# Query_time: .*Lock_time: .*Rows_sent:/# Query_time: n Lock_time: n Rows_sent:/
--let $PATTERN_TS= /SET timestamp=.*\n//

--echo
--echo ###################################
--echo ## Testing log_slow_extra behavior.

# These regex patterns are for masking-out non-deterministic output.
--let $PATTERN_UH= /^# User@Host:.*Id:.*Db:/# User@Host: n Id: n Db:/
--let $PATTERN_THREAD= /Thread_id:.*Errno:/Thread_id: n Errno:/
--let $PATTERN_BR= /Bytes_received:.*Bytes_sent:.*Read_first:/Bytes_received: n Bytes_sent: n Read_first:/
--let $PATTERN_START= /Start:.*End:.*/Start: n End: n/

--let $PATTERN= $PATTERN_COMMON $PATTERN_UH $PATTERN_QT $PATTERN_THREAD $PATTERN_BR $PATTERN_START $PATTERN_TS

# Doing tests with log_slow_extra_db = 1 allows not having to manage "use ..." in the output.
--echo
--echo ## Testing log_slow_extra behavior is done with log_slow_extra_db = 1.
SET @@global.log_slow_extra_db = 1;

--source include/slow_query_log_file_reset.inc

--echo
--echo ## Testing log_slow_extra = 0.
SET @@global.log_slow_extra = 0;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

--source include/slow_query_log_file_reset.inc

--echo
--echo ## Testing log_slow_extra = 1.
SET @@global.log_slow_extra = 1;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

--echo
--echo ######################################
--echo ## Testing log_slow_extra_db behavior.

# These regex patterns are for masking-out non-deterministic output.
# Replacing User@Host by UH as a trick to conserve "Db: ..." when it is there.
--let $PATTERN_UH1= /^# User@Host:.*Id:.*Db:/# UH: n Id: n Db:/
--let $PATTERN_UH2= /^# User@Host:.*Id:.*/# UH: n Id: n/

--let $PATTERN= $PATTERN_COMMON $PATTERN_UH1 $PATTERN_UH2 $PATTERN_QT $PATTERN_TS

--echo
--echo ## Testing log_slow_extra_db behavior is done with log_slow_extra = 0.
SET @@global.log_slow_extra = 0;

--source include/slow_query_log_file_reset.inc

# We test log_slow_extra_db = 1 before 0 as we want to make sure a "use ..." appears with 0.

--echo 
--echo ## Testing log_slow_extra_db = 1.
SET @@global.log_slow_extra_db = 1;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

--source include/slow_query_log_file_reset.inc

# As we tested with 1 before, we expect a "use ..." to appear with 0.

--echo
--echo ## Testing log_slow_extra_db = 0.
SET @@global.log_slow_extra_db = 0;
SELECT sleep(0.5);

--echo
--echo ## Checking the content of the slow query log file.
--replace_regex $PATTERN
--exec cat $MYSQLD_DATADIR/my_slow_test.log

# Cleanup.
--remove_file $MYSQLD_DATADIR/my_slow_test.log

--echo
--echo ## Restore state.
# These need to go before log_output as they might warn otherwise.
SET @@global.log_slow_extra = @global_log_slow_extra;
SET @@global.log_slow_extra_db = @global_log_slow_extra_db;

SET @@global.log_output = @global_log_output;
SET @@global.slow_query_log = @global_slow_query_log;
SET @@global.slow_query_log_file = @global_slow_query_log_file;

# EOF.